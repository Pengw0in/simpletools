<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Image Converter</title>
    <link rel="icon" type="image/x-icon" href="../../public/logo.ico">
    <link rel="stylesheet" href="/components/toggle.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 768px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 300;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 100;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            line-height: 0;
        }

        .theme-toggle:hover {
            background: var(--hover-bg);
            border-color: var(--text-secondary);
            color: var(--text-primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            padding: 32px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: block;
        }

        .file-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .file-input:focus {
            outline: none;
            border-color: var(--text-primary);
            box-shadow: 0 0 0 1px var(--text-primary);
        }

        .file-count {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            text-align: center;
            font-weight: 500;
        }

        .select-input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .select-input:focus {
            outline: none;
            border-color: var(--text-primary);
            box-shadow: 0 0 0 1px var(--text-primary);
        }

        .btn {
            width: 100%;
            padding: 12px 0;
            background: var(--text-primary);
            color: var(--card-bg);
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 300;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background 0.2s, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:disabled {
            background: var(--border-color);
            color: var(--text-secondary);
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn:hover:not(:disabled) {
            background: var(--text-secondary);
            color: var(--card-bg);
            transform: translateY(-1px);
        }

        .file-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }

        .file-item {
            display: grid;
            grid-template-columns: 1fr auto auto;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item-name {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 15px;
        }

        .file-item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .convert-single-btn {
            padding: 8px 12px;
            background: var(--text-primary);
            color: var(--card-bg);
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }

        .convert-single-btn:disabled {
            background: var(--border-color);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .convert-single-btn:hover:not(:disabled) {
            background: var(--text-secondary);
            transform: scale(1.02);
        }

        .btn-icon {
            width: 20px;
            height: 20px;
            color: inherit;
            vertical-align: middle;
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg);}
        }

        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            background: var(--notification-bg);
            color: var(--card-bg);
            border-radius: 4px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 1000;
        }

        .notification.error {
            background: var(--error-color);
        }

        [data-theme="dark"] .notification {
            background: #fafafa;
            color: #222;
        }
        [data-theme="dark"] .notification.error {
            background: #ff6b6b;
            color: #fff;
        }

        .notification.show {
            opacity: 1;
        }

        .hidden {
            display: none;
        }

        .status-badge {
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 3px;
            margin-left: 10px;
            font-weight: 600;
            color: white;
            white-space: nowrap;
        }

        .status-badge.converting { background-color: orange; }
        .status-badge.converted { background: var(--success-color); }
        .status-badge.error { background: var(--error-color); }

        @media (max-width: 600px) {
            .container {
                padding: 20px 8px;
            }
            .card {
                padding: 16px;
            }
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                <i data-lucide="sun" class="theme-icon" id="theme-icon"></i>
            </button>
            <h1>Universal Image Converter</h1>
            <p>Select multiple images and choose a separate format for each.</p>
        </div>
        <div class="card">
            <div class="form-group">
                <label for="fileInput" class="form-label">Select Image Files (JPG, PNG, WebP, etc.)</label>
                <input type="file" id="fileInput" accept="image/*" class="file-input" multiple>
            </div>
            
            <div id="fileListContainer" class="hidden">
                <label class="form-label">Configure Conversions</label>
                <ul id="fileList" class="file-list">
                    </ul>
                <hr style="margin: 20px 0; border-color: var(--border-color);">
                <button id="convertAllBtn" class="btn" disabled>
                    <i data-lucide="wand-2" class="btn-icon"></i>
                    <span id="buttonText">Convert All Images</span>
                </button>
            </div>
            
            <div id="noFilesMessage" style="text-align: center; color: var(--text-secondary); margin-top: 10px;">
                No files selected yet.
            </div>

            <canvas id="conversionCanvas" style="display:none;"></canvas>
        </div>
        <div id="notification" class="notification"></div>
    </div>
    <script src="/components/toggle.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script>
        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const fileListContainer = document.getElementById('fileListContainer');
        const fileListUL = document.getElementById('fileList');
        const convertAllBtn = document.getElementById('convertAllBtn');
        const noFilesMessage = document.getElementById('noFilesMessage');
        const canvas = document.getElementById('conversionCanvas');
        const ctx = canvas.getContext('2d');

        // State
        let selectedFiles = []; // Array to hold File objects

        // Map MimeType to standard extension for file naming
        const extensionMap = {
            'image/png': 'png',
            'image/jpeg': 'jpg',
            'image/webp': 'webp'
        };

        const formatOptions = [
            { value: 'image/png', text: 'PNG' },
            { value: 'image/jpeg', text: 'JPEG/JPG' },
            { value: 'image/webp', text: 'WebP' },
        ];

        // Helper function to convert Data URL (base64) to a Blob object
        function dataURLtoBlob(dataURL) {
            const parts = dataURL.split(';base64,');
            if (parts.length !== 2) return null;
            const contentType = parts[0].split(':')[1];
            const raw = window.atob(parts[1]);
            const rawLength = raw.length;
            const uInt8Array = new Uint8Array(rawLength);
            for (let i = 0; i < rawLength; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }
            return new Blob([uInt8Array], { type: contentType });
        }

        // Status message utility (using notification div)
        function setStatus(message, type = 'info') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.classList.remove('error', 'success', 'show');
            notif.classList.add(type);
            notif.classList.add('show');
            setTimeout(() => {
                notif.classList.remove('show');
            }, 3000);
        }
        
        // Update the status badge for a single file item
        function updateFileStatus(index, status) {
            const item = document.getElementById(`file-item-${index}`);
            if (!item) return;

            // Clear existing badges
            item.querySelectorAll('.status-badge').forEach(badge => badge.remove());
            
            let badge = document.createElement('span');
            badge.classList.add('status-badge');
            
            if (status === 'converting') {
                badge.classList.add('converting');
                badge.textContent = 'Converting...';
            } else if (status === 'converted') {
                badge.classList.add('converted');
                badge.textContent = 'Done!';
            } else if (status === 'error') {
                badge.classList.add('error');
                badge.textContent = 'Error';
            } else {
                return; // No status update needed
            }
            
            item.querySelector('.file-item-name').appendChild(badge);
        }

        // Generate HTML for a single file item
        function createFileListItem(file, index) {
            const li = document.createElement('li');
            li.className = 'file-item';
            li.id = `file-item-${index}`;
            
            const fileName = file.name;
            const originalExtension = fileName.split('.').pop().toUpperCase();
            
            li.innerHTML = `
                <div class="file-item-name" title="${fileName}">${fileName}</div>
                <div class="file-item-actions">
                    <select id="targetFormat-${index}" class="select-input">
                        ${formatOptions.map(opt => 
                            `<option value="${opt.value}" ${opt.text.includes(originalExtension) ? 'selected' : ''}>${opt.text}</option>`
                        ).join('')}
                    </select>
                    <button class="convert-single-btn" data-index="${index}">Convert</button>
                </div>
            `;
            return li;
        }

        // Function to update UI based on selectedFiles
        function updateUI() {
            fileListUL.innerHTML = ''; // Clear previous list

            if (selectedFiles.length > 0) {
                selectedFiles.forEach((file, index) => {
                    fileListUL.appendChild(createFileListItem(file, index));
                });
                fileListContainer.classList.remove('hidden');
                noFilesMessage.classList.add('hidden');
                convertAllBtn.disabled = false;
                setStatus(`${selectedFiles.length} file(s) selected. Configure and convert.`, 'info');
            } else {
                fileListContainer.classList.add('hidden');
                noFilesMessage.classList.remove('hidden');
                convertAllBtn.disabled = true;
                // Remove or change the status message for empty state
                // setStatus('Please select image files.', 'info'); // Optional: show info instead of error
            }
            if (typeof lucide !== 'undefined') lucide.createIcons(); // Re-render Lucide icons if any were used
        }

        // Event listener for file selection (handles multiple)
        fileInput.addEventListener('change', (event) => {
            selectedFiles = Array.from(event.target.files);
            updateUI();
        });
        
        // Single Image Conversion Logic
        function convertSingleImage(file, index) {
            return new Promise((resolve, reject) => {
                const targetFormatSelect = document.getElementById(`targetFormat-${index}`);
                const convertBtn = document.querySelector(`.convert-single-btn[data-index="${index}"]`);

                if (!file || !targetFormatSelect || !convertBtn) {
                    return reject('File, format selector, or button element not found.');
                }
                
                const originalFileName = file.name.substring(0, file.name.lastIndexOf('.')) || 'converted_image';
                const targetMimeType = targetFormatSelect.value;
                const targetExtension = extensionMap[targetMimeType] || 'file';

                updateFileStatus(index, 'converting');
                convertBtn.disabled = true;
                convertBtn.textContent = '...';

                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        let objectURL = null;
                        try {
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(img, 0, 0);
                            
                            // Quality setting: 0.9 for JPEG/WebP, 1.0 for PNG
                            const quality = (targetMimeType === 'image/jpeg' || targetMimeType === 'image/webp') ? 0.9 : 1.0;
                            const dataURL = canvas.toDataURL(targetMimeType, quality);
                            const blob = dataURLtoBlob(dataURL);
                            if (!blob) throw new Error("Could not create Blob from image data.");
                            
                            objectURL = URL.createObjectURL(blob);

                            // Automatic download trigger
                            const a = document.createElement('a');
                            a.href = objectURL;
                            a.download = `${originalFileName}.${targetExtension}`;
                            document.body.appendChild(a);
                            a.click();
                            
                            // Clean up
                            setTimeout(() => {
                                URL.revokeObjectURL(objectURL);
                                document.body.removeChild(a);
                            }, 100);

                            updateFileStatus(index, 'converted');
                            convertBtn.textContent = 'Convert';
                            resolve(`File ${file.name} converted successfully to ${targetExtension.toUpperCase()}.`);
                        } catch (error) {
                            console.error(`Conversion failed for ${file.name}:`, error);
                            if (objectURL) URL.revokeObjectURL(objectURL);
                            updateFileStatus(index, 'error');
                            convertBtn.textContent = 'Error';
                            convertBtn.disabled = false; // Allow retrying
                            reject(`Conversion failed for ${file.name}.`);
                        }
                    };
                    img.onerror = function() {
                        updateFileStatus(index, 'error');
                        convertBtn.textContent = 'Convert';
                        convertBtn.disabled = false;
                        reject(`Failed to load image for ${file.name}.`);
                    };
                    img.src = e.target.result;
                };
                reader.onerror = function() {
                    updateFileStatus(index, 'error');
                    convertBtn.textContent = 'Convert';
                    convertBtn.disabled = false;
                    reject(`Failed to read file ${file.name} from disk.`);
                };
                reader.readAsDataURL(file);
            });
        }
        
        // Event delegation for single convert buttons
        fileListUL.addEventListener('click', (event) => {
            const btn = event.target.closest('.convert-single-btn');
            if (btn) {
                const index = parseInt(btn.dataset.index);
                const fileToConvert = selectedFiles[index];
                
                if (fileToConvert) {
                    convertSingleImage(fileToConvert, index)
                        .then(msg => setStatus(msg, 'success'))
                        .catch(err => setStatus(err, 'error'));
                } else {
                    setStatus('File not found in the list.', 'error');
                }
            }
        });

        // Event listener for Convert All button
        convertAllBtn.addEventListener('click', async () => {
            if (selectedFiles.length === 0) {
                setStatus('No files to convert.', 'error');
                return;
            }

            convertAllBtn.disabled = true;
            document.getElementById('buttonText').textContent = 'Converting All...';
            
            const results = [];
            
            for (let i = 0; i < selectedFiles.length; i++) {
                try {
                    const result = await convertSingleImage(selectedFiles[i], i);
                    results.push({ file: selectedFiles[i].name, status: 'success', message: result });
                } catch (error) {
                    results.push({ file: selectedFiles[i].name, status: 'error', message: error });
                }
            }
            
            convertAllBtn.disabled = false;
            document.getElementById('buttonText').textContent = 'Convert All Images';

            const successCount = results.filter(r => r.status === 'success').length;
            const errorCount = results.length - successCount;
            
            if (errorCount > 0) {
                setStatus(`Finished batch conversion: ${successCount} successful, ${errorCount} failed. Check individual statuses.`, 'error');
            } else {
                setStatus(`Successfully converted all ${successCount} files!`, 'success');
            }
        });


        window.onload = function() {
            fileInput.value = ''; // Clear any residual value
            selectedFiles = []; // Ensure array is empty
            updateUI(); // Update UI to reflect empty state
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };
    </script>
</body>
</html>