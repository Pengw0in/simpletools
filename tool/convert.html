<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/public/logo.ico">
    <title>Unit Converter</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        /* Global Reset and Retro Font */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* Use the pixel font */
            font-family: 'Press Start 2P', cursive;
        }

        /* Basic Retro Color Palette */
        :root {
            --window-bg: #c0c0c0; 
            --border-dark: #808080;
            --border-light: #ffffff;
            --text-color: #000000;
            --button-face: #c0c0c0;
            --button-pressed: #dfdfdf;
            --input-bg: #ffffff;
            --header-title: #000080; 
        }

        body {
            background: var(--window-bg);
            color: var(--text-color);
            line-height: 1.6;
            padding: 30px; /* Increased body padding */
        }

        /* --- Classic Windows Border Mixin --- */
        .window-frame {
            border-style: solid;
            border-width: 3px; /* Increased border thickness */
            border-color: var(--border-light) var(--border-dark) var(--border-dark) var(--border-light);
            background: var(--window-bg);
            padding: 3px; 
            box-shadow: none;
        }

        .container {
            max-width: 650px; /* Slightly wider container */
            margin: 0 auto;
            padding: 0; 
        }

        /* --- Title Bar/Header --- */
        .header {
            text-align: left;
            margin-bottom: 12px;
            position: relative;
        }

        .title-bar {
            background: #008080;
            color: var(--border-light);
            padding: 5px 8px; /* Increased padding */
            font-size: 16px; /* Slightly larger font */
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-dark);
        }

        .title-bar-text {
            white-space: nowrap;
        }

        /* The main window body */
        .app-body {
            padding: 15px; /* Increased inner padding */
        }

        /* --- The Retro Button Style --- */
        .retro-button {
            border-style: solid;
            border-width: 3px; /* Increased border thickness */
            border-color: var(--border-light) var(--border-dark) var(--border-dark) var(--border-light);
            background: var(--button-face);
            color: var(--text-color);
            padding: 8px 15px; /* Increased padding */
            font-size: 11px; /* Slightly larger font */
            text-align: center;
            cursor: pointer;
            transition: none;
            box-shadow: none;
            line-height: 1;
        }

        .retro-button:active {
            border-color: var(--border-dark) var(--border-light) var(--border-light) var(--border-dark);
            padding: 9px 14px 7px 16px; /* Adjusted shift for thicker border */
        }

        .theme-toggle {
            display: none;
        }

        /* --- Category Selector (Tabs) --- */
        .category-selector {
            margin-bottom: 15px; /* Increased margin */
        }

        .category-tabs {
            display: flex;
            flex-wrap: wrap;
            padding: 12px; /* Increased padding */
            gap: 6px; /* Increased gap */
            border-style: solid;
            border-width: 3px; /* Increased border thickness */
            border-color: var(--border-dark) var(--border-light) var(--border-light) var(--border-dark);
            background: var(--window-bg);
            margin-top: -1px; 
        }

        .category-tab {
            flex-grow: 1;
            min-width: 90px; /* Wider buttons */
            border: 3px solid; /* Thicker border */
            border-color: var(--border-light) var(--border-dark) var(--border-dark) var(--border-light);
            background: var(--button-face);
            font-size: 10px; /* Slightly larger font */
            padding: 6px 10px; /* Increased padding */
            cursor: pointer;
            transition: none;
        }

        .category-tab.active {
            border-color: var(--border-dark) var(--border-light) var(--border-light) var(--border-dark);
            background: var(--button-pressed);
            padding: 7px 9px 5px 11px; /* Adjusted shift for thicker border */
            font-weight: bold;
        }

        /* --- Converter Section (Sunken Panel) --- */
        .converter-section {
            margin-bottom: 15px;
            border-style: solid;
            border-width: 3px; /* Increased border thickness */
            border-color: var(--border-dark) var(--border-light) var(--border-light) var(--border-dark);
            background: var(--button-pressed);
            padding: 1px;
        }

        .converter-content {
            padding: 15px; /* Increased content padding */
        }

        .conversion-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 12px; /* Increased gap */
            align-items: center;
            margin-bottom: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px; /* Increased gap */
        }

        .input-label {
            font-size: 11px; /* Larger font */
            font-weight: normal;
            color: var(--text-color);
        }

        /* --- Input and Select Fields (Sunken) --- */
        .unit-input {
            padding: 6px; /* Increased padding */
            border: 1px solid;
            border-color: var(--border-dark) var(--border-light) var(--border-light) var(--border-dark);
            font-size: 12px; /* Larger font */
            outline: none;
            background: var(--input-bg);
            color: var(--text-color);
            height: 32px; /* Increased height */
            line-height: 1;
            text-align: left;
        }
        
        .unit-input[readonly] {
            background: var(--button-face);
            color: var(--border-dark);
        }

        /* We remove the native select arrow here */
        .unit-select {
            padding: 6px;
            border: 1px solid;
            border-color: var(--border-dark) var(--border-light) var(--border-light) var(--border-dark);
            font-size: 12px; 
            outline: none;
            background: var(--input-bg);
            color: var(--text-color);
            height: 32px;
            line-height: 1;
            /* Remove standard select styling */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none !important;
            padding-right: 6px;
        }

        .swap-button {
            border-style: solid;
            border-width: 3px; /* Thicker border */
            border-color: var(--border-light) var(--border-dark) var(--border-dark) var(--border-light);
            background: var(--button-face);
            font-size: 16px; /* Larger icon/text */
            color: var(--text-color);
            padding: 6px; /* Increased padding */
            min-height: 32px; /* Matches input height */
            width: 40px; /* Wider button */
            line-height: 1;
            margin-bottom: 30px; /* Aligns with bottom of larger inputs */
            cursor: pointer;
            transition: none;
        }
        
        .swap-button:active {
            border-color: var(--border-dark) var(--border-light) var(--border-light) var(--border-dark);
            padding: 7px 5px 5px 7px; /* Adjusted shift */
        }

        /* --- Formula/Error Display --- */
        .conversion-formula, .error {
            border-style: solid;
            border-width: 3px; /* Thicker border */
            border-color: var(--border-dark) var(--border-light) var(--border-light) var(--border-dark);
            padding: 8px; /* Increased padding */
            font-family: 'Press Start 2P', monospace; 
            font-size: 10px; /* Larger font */
            color: var(--text-color);
            margin-top: 15px;
            background: var(--input-bg);
            overflow-x: auto;
        }

        .error {
            background: #ffcccc; 
        }

        .hidden {
            display: none;
        }
        
        /* --- Common Conversions --- */
        .common-conversions {
            margin-top: 15px;
            padding: 0;
        }
        
        .common-header {
            font-size: 11px; /* Larger font */
            font-weight: bold;
            padding: 6px 0;
        }

        .common-list {
            border-style: solid;
            border-width: 3px; /* Thicker border */
            border-color: var(--border-dark) var(--border-light) var(--border-light) var(--border-dark);
            background: var(--input-bg);
            padding: 8px; /* Increased padding */
        }

        .common-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0; /* Increased padding */
            border-bottom: none; 
            font-size: 10px; /* Larger font */
        }

        .common-left, .common-right {
            color: var(--text-color);
            font-family: 'Press Start 2P', cursive;
        }

        /* --- Custom Select Dropdown Styling --- */
        .custom-select-wrapper {
            position: relative;
            height: 32px;
        }

        .hidden-native-select {
            display: none !important;
        }

        .custom-select-display {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            outline: none; 
        }

        .custom-select-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 5px; 
        }

        .custom-select-arrow {
            font-size: 10px;
            line-height: 1;
            padding-left: 5px; 
        }

        /* The options list uses the classic window border */
        .custom-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            z-index: 100;
            
            border-style: solid;
            border-width: 3px;
            border-color: var(--border-light) var(--border-dark) var(--border-dark) var(--border-light);
            background: var(--window-bg);
            
            max-height: 200px;
            overflow-y: auto;
            margin-top: 3px; 
        }

        .custom-select-option {
            padding: 6px;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background: var(--input-bg); 
            border-bottom: 1px solid var(--border-dark);
        }

        .custom-select-option:last-child {
            border-bottom: none;
        }

        /* Blue highlight on hover/selected */
        .custom-select-option:hover,
        .custom-select-option.selected {
            background: var(--header-title); 
            color: var(--border-light); 
        }

        .custom-select-display:focus {
            box-shadow: 0 0 0 1px var(--text-color) inset;
        }

        /* Adjustments for smaller screens (still retro, but responsive) */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                max-width: 100%;
            }

            .conversion-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .swap-button {
                order: -1;
                width: 40px;
                height: 32px;
                margin: 0 auto;
                padding: 0;
                margin-bottom: 0;
            }
            
            .swap-button:active {
                padding: 1px 0 0 1px;
            }

            .category-tabs {
                justify-content: space-around;
            }
        }
    </style>
</head>
<body>
    <div class="container window-frame">
        <div class="title-bar">
            <div class="title-bar-text">Unit Converter</div>
        </div>
        
        <div class="app-body">
            <div class="category-selector">
                <div class="category-tabs">
                    <button class="category-tab active" data-category="length">Length</button>
                    <button class="category-tab" data-category="weight">Weight</button>
                    <button class="category-tab" data-category="temperature">Temp</button>
                    <button class="category-tab" data-category="area">Area</button>
                    <button class="category-tab" data-category="volume">Volume</button>
                    <button class="category-tab" data-category="speed">Speed</button>
                    <button class="category-tab" data-category="time">Time</button>
                    <button class="category-tab" data-category="energy">Energy</button>
                </div>
            </div>

            <div class="converter-section">
                <div class="converter-content">
                    <div class="conversion-row">
                        <div class="input-group">
                            <label class="input-label">From</label>
                            <input 
                                type="number" 
                                id="fromInput" 
                                class="unit-input" 
                                placeholder="Enter value"
                                oninput="convertUnits()"
                            >
                            <div id="fromUnitWrapper" class="custom-select-wrapper">
                                <div id="fromUnitDisplay" class="custom-select-display unit-select" tabindex="0" role="combobox" aria-haspopup="listbox" aria-expanded="false">
                                    <span class="custom-select-text"></span>
                                    <span class="custom-select-arrow">▼</span>
                                </div>
                                <div id="fromUnitOptions" class="custom-select-options hidden" role="listbox">
                                    </div>
                                <select id="fromUnit" class="hidden-native-select" onchange="convertUnits()">
                                    </select>
                            </div>
                            </div>
                        
                        <button class="swap-button" onclick="swapUnits()" title="Swap units">
                            ⇄
                        </button>
                        
                        <div class="input-group">
                            <label class="input-label">To</label>
                            <input 
                                type="number" 
                                id="toInput" 
                                class="unit-input" 
                                placeholder="Result"
                                readonly
                            >
                            <div id="toUnitWrapper" class="custom-select-wrapper">
                                <div id="toUnitDisplay" class="custom-select-display unit-select" tabindex="0" role="combobox" aria-haspopup="listbox" aria-expanded="false">
                                    <span class="custom-select-text"></span>
                                    <span class="custom-select-arrow">▼</span>
                                </div>
                                <div id="toUnitOptions" class="custom-select-options hidden" role="listbox">
                                    </div>
                                <select id="toUnit" class="hidden-native-select" onchange="convertUnits()">
                                    </select>
                            </div>
                            </div>
                    </div>

                    <div id="conversionFormula" class="conversion-formula hidden">
                        </div>

                    <div id="errorMessage" class="error hidden">
                        </div>
                </div>
            </div>

            <div class="common-conversions">
                <div class="common-header">Common Conversions</div>
                <div class="common-list" id="commonList">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // Unit definitions and conversion factors (unchanged)
        const unitCategories = {
            length: {
                name: 'Length',
                baseUnit: 'meter',
                units: {
                    millimeter: { factor: 0.001, symbol: 'mm', name: 'Millimeter' },
                    centimeter: { factor: 0.01, symbol: 'cm', name: 'Centimeter' },
                    meter: { factor: 1, symbol: 'm', name: 'Meter' },
                    kilometer: { factor: 1000, symbol: 'km', name: 'Kilometer' },
                    inch: { factor: 0.0254, symbol: 'in', name: 'Inch' },
                    foot: { factor: 0.3048, symbol: 'ft', name: 'Foot' },
                    yard: { factor: 0.9144, symbol: 'yd', name: 'Yard' },
                    mile: { factor: 1609.34, symbol: 'mi', name: 'Mile' }
                },
                common: [
                    ['1 meter', '100 centimeters'],
                    ['1 kilometer', '1000 meters'],
                    ['1 foot', '12 inches'],
                    ['1 yard', '3 feet'],
                    ['1 mile', '5280 feet']
                ]
            },
            weight: {
                name: 'Weight',
                baseUnit: 'kilogram',
                units: {
                    milligram: { factor: 0.000001, symbol: 'mg', name: 'Milligram' },
                    gram: { factor: 0.001, symbol: 'g', name: 'Gram' },
                    kilogram: { factor: 1, symbol: 'kg', name: 'Kilogram' },
                    ton: { factor: 1000, symbol: 't', name: 'Metric Ton' },
                    ounce: { factor: 0.0283495, symbol: 'oz', name: 'Ounce' },
                    pound: { factor: 0.453592, symbol: 'lb', name: 'Pound' },
                    stone: { factor: 6.35029, symbol: 'st', name: 'Stone' }
                },
                common: [
                    ['1 kilogram', '1000 grams'],
                    ['1 pound', '16 ounces'],
                    ['1 stone', '14 pounds'],
                    ['1 ton', '1000 kilograms']
                ]
            },
            temperature: {
                name: 'Temperature',
                baseUnit: 'celsius',
                units: {
                    celsius: { symbol: '°C', name: 'Celsius' },
                    fahrenheit: { symbol: '°F', name: 'Fahrenheit' },
                    kelvin: { symbol: 'K', name: 'Kelvin' }
                },
                common: [
                    ['0°C', '32°F (Freezing)'],
                    ['100°C', '212°F (Boiling)'],
                    ['37°C', '98.6°F (Body temp)'],
                    ['20°C', '68°F (Room temp)']
                ]
            },
            area: {
                name: 'Area',
                baseUnit: 'square_meter',
                units: {
                    square_millimeter: { factor: 0.000001, symbol: 'mm²', name: 'Square Millimeter' },
                    square_centimeter: { factor: 0.0001, symbol: 'cm²', name: 'Square Centimeter' },
                    square_meter: { factor: 1, symbol: 'm²', name: 'Square Meter' },
                    square_kilometer: { factor: 1000000, symbol: 'km²', name: 'Square Kilometer' },
                    square_inch: { factor: 0.00064516, symbol: 'in²', name: 'Square Inch' },
                    square_foot: { factor: 0.092903, symbol: 'ft²', name: 'Square Foot' },
                    acre: { factor: 4046.86, symbol: 'ac', name: 'Acre' },
                    hectare: { factor: 10000, symbol: 'ha', name: 'Hectare' }
                },
                common: [
                    ['1 m²', '10000 cm²'],
                    ['1 km²', '100 hectares'],
                    ['1 acre', '4047 m²'],
                    ['1 ft²', '144 in²']
                ]
            },
            volume: {
                name: 'Volume',
                baseUnit: 'liter',
                units: {
                    milliliter: { factor: 0.001, symbol: 'ml', name: 'Milliliter' },
                    liter: { factor: 1, symbol: 'L', name: 'Liter' },
                    cubic_meter: { factor: 1000, symbol: 'm³', name: 'Cubic Meter' },
                    fluid_ounce: { factor: 0.0295735, symbol: 'fl oz', name: 'Fluid Ounce' },
                    cup: { factor: 0.236588, symbol: 'cup', name: 'Cup' },
                    pint: { factor: 0.473176, symbol: 'pt', name: 'Pint' },
                    quart: { factor: 0.946353, symbol: 'qt', name: 'Quart' },
                    gallon: { factor: 3.78541, symbol: 'gal', name: 'Gallon' }
                },
                common: [
                    ['1 liter', '1000 milliliters'],
                    ['1 gallon', '4 quarts'],
                    ['1 quart', '2 pints'],
                    ['1 cup', '8 fluid ounces']
                ]
            },
            speed: {
                name: 'Speed',
                baseUnit: 'meter_per_second',
                units: {
                    meter_per_second: { factor: 1, symbol: 'm/s', name: 'Meter per Second' },
                    kilometer_per_hour: { factor: 0.277778, symbol: 'km/h', name: 'Kilometer per Hour' },
                    mile_per_hour: { factor: 0.44704, symbol: 'mph', name: 'Mile per Hour' },
                    foot_per_second: { factor: 0.3048, symbol: 'ft/s', name: 'Foot per Second' },
                    knot: { factor: 0.514444, symbol: 'kn', name: 'Knot' }
                },
                common: [
                    ['1 m/s', '3.6 km/h'],
                    ['1 mph', '1.609 km/h'],
                    ['1 knot', '1.852 km/h'],
                    ['100 km/h', '62.1 mph']
                ]
            },
            time: {
                name: 'Time',
                baseUnit: 'second',
                units: {
                    millisecond: { factor: 0.001, symbol: 'ms', name: 'Millisecond' },
                    second: { factor: 1, symbol: 's', name: 'Second' },
                    minute: { factor: 60, symbol: 'min', name: 'Minute' },
                    hour: { factor: 3600, symbol: 'h', name: 'Hour' },
                    day: { factor: 86400, symbol: 'd', name: 'Day' },
                    week: { factor: 604800, symbol: 'wk', name: 'Week' },
                    month: { factor: 2629746, symbol: 'mo', name: 'Month (avg)' },
                    year: { factor: 31556952, symbol: 'yr', name: 'Year (avg)' }
                },
                common: [
                    ['1 minute', '60 seconds'],
                    ['1 hour', '60 minutes'],
                    ['1 day', '24 hours'],
                    ['1 week', '7 days'],
                    ['1 year', '365.25 days']
                ]
            },
            energy: {
                name: 'Energy',
                baseUnit: 'joule',
                units: {
                    joule: { factor: 1, symbol: 'J', name: 'Joule' },
                    kilojoule: { factor: 1000, symbol: 'kJ', name: 'Kilojoule' },
                    calorie: { factor: 4.184, symbol: 'cal', name: 'Calorie' },
                    kilocalorie: { factor: 4184, symbol: 'kcal', name: 'Kilocalorie' },
                    watt_hour: { factor: 3600, symbol: 'Wh', name: 'Watt Hour' },
                    kilowatt_hour: { factor: 3600000, symbol: 'kWh', name: 'Kilowatt Hour' },
                    btu: { factor: 1055.06, symbol: 'BTU', name: 'British Thermal Unit' }
                },
                common: [
                    ['1 kJ', '1000 J'],
                    ['1 kcal', '4.184 kJ'],
                    ['1 kWh', '3.6 MJ'],
                    ['1 BTU', '1.055 kJ']
                ]
            }
        };

        let currentCategory = 'length';

        // --- Custom Select Dropdown Logic ---

        // Function to toggle the custom select dropdown
        function toggleCustomSelect(displayElement, optionsElement) {
            const isExpanded = displayElement.getAttribute('aria-expanded') === 'true';
            closeAllCustomSelects(); // Close all first

            if (!isExpanded) {
                optionsElement.classList.remove('hidden');
                displayElement.setAttribute('aria-expanded', 'true');
            }
        }

        // Function to close all open custom selects
        function closeAllCustomSelects() {
            document.querySelectorAll('.custom-select-options').forEach(optionsDiv => {
                optionsDiv.classList.add('hidden');
            });
            document.querySelectorAll('.custom-select-display').forEach(displayDiv => {
                displayDiv.setAttribute('aria-expanded', 'false');
            });
        }
        
        // --- Core Converter Logic ---

        // Initialize the converter
        function initConverter() {
            setupCategoryTabs();
            loadCategory(currentCategory);
            updateCommonConversions();
            
            // Attach a global click handler to close dropdowns when clicking outside
            document.addEventListener('click', closeAllCustomSelects);
        }

        // Setup category tab event listeners
        function setupCategoryTabs() {
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const category = tab.getAttribute('data-category');
                    switchCategory(category);
                });
            });
        }

        // Switch to a different category
        function switchCategory(category) {
            // Update active tab
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.toggle('active', tab.getAttribute('data-category') === category);
            });

            currentCategory = category;
            loadCategory(category);
            updateCommonConversions();
            clearInputs();
        }

        // Load units for a specific category
        function loadCategory(category) {
            const categoryData = unitCategories[category];
            
            // Define the select components to update
            const selects = [
                { id: 'fromUnit', displayId: 'fromUnitDisplay', optionsId: 'fromUnitOptions' },
                { id: 'toUnit', displayId: 'toUnitDisplay', optionsId: 'toUnitOptions' }
            ];

            selects.forEach(selectData => {
                const nativeSelect = document.getElementById(selectData.id);
                const customOptionsDiv = document.getElementById(selectData.optionsId); 
                const customDisplay = document.getElementById(selectData.displayId);
                const customTextSpan = customDisplay.querySelector('.custom-select-text');

                // Clear existing options
                nativeSelect.innerHTML = '';
                customOptionsDiv.innerHTML = '';
                
                // Clear existing event listener before adding new one
                const newDisplay = customDisplay.cloneNode(true);
                customDisplay.parentNode.replaceChild(newDisplay, customDisplay);
                const finalDisplay = document.getElementById(selectData.displayId);
                const finalTextSpan = finalDisplay.querySelector('.custom-select-text');

                // Add unit options
                Object.keys(categoryData.units).forEach(unitKey => {
                    const unit = categoryData.units[unitKey];
                    const optionText = `${unit.name} (${unit.symbol})`;
                    
                    // 1. Add to native select (for conversion logic and fallback)
                    const option = new Option(optionText, unitKey);
                    nativeSelect.add(option);

                    // 2. Add to custom options list
                    const customOption = document.createElement('div');
                    customOption.className = 'custom-select-option';
                    customOption.setAttribute('data-value', unitKey);
                    customOption.setAttribute('role', 'option');
                    customOption.textContent = optionText;
                    
                    // Attach click handler for custom option
                    customOption.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // Set native select value
                        nativeSelect.value = unitKey;
                        
                        // Update display text
                        finalTextSpan.textContent = optionText;
                        
                        // Close the dropdown and trigger conversion
                        closeAllCustomSelects();
                        convertUnits(); 
                    });
                    
                    customOptionsDiv.appendChild(customOption);
                });

                // Set default selections
                const unitKeys = Object.keys(categoryData.units);
                if (unitKeys.length >= 2) {
                    // Set native select value
                    const defaultValue = (selectData.id === 'fromUnit') ? unitKeys[0] : unitKeys[1];
                    nativeSelect.value = defaultValue;
                    
                    // Set initial display text
                    const defaultUnit = categoryData.units[defaultValue];
                    finalTextSpan.textContent = `${defaultUnit.name} (${defaultUnit.symbol})`;
                }
                
                // Setup custom select display click handler (to open/close dropdown)
                finalDisplay.onclick = (e) => {
                    e.stopPropagation();
                    toggleCustomSelect(finalDisplay, customOptionsDiv);
                };
                
                // Setup keyboard navigation 
                finalDisplay.onkeydown = (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        toggleCustomSelect(finalDisplay, customOptionsDiv);
                    }
                };
            });
        }

        // Update common conversions display
        function updateCommonConversions() {
            const categoryData = unitCategories[currentCategory];
            const commonList = document.getElementById('commonList');
            
            commonList.innerHTML = '';
            
            categoryData.common.forEach(([left, right]) => {
                const item = document.createElement('div');
                item.className = 'common-item';
                item.innerHTML = `
                    <span class="common-left">${left}</span>
                    <span class="common-right">${right}</span>
                `;
                commonList.appendChild(item);
            });
        }

        // Convert temperature (special case)
        function convertTemperature(value, fromUnit, toUnit) {
            // Convert to Celsius first
            let celsius;
            switch (fromUnit) {
                case 'celsius':
                    celsius = value;
                    break;
                case 'fahrenheit':
                    celsius = (value - 32) * 5/9;
                    break;
                case 'kelvin':
                    celsius = value - 273.15;
                    break;
            }

            // Convert from Celsius to target unit
            switch (toUnit) {
                case 'celsius':
                    return celsius;
                case 'fahrenheit':
                    return celsius * 9/5 + 32;
                case 'kelvin':
                    return celsius + 273.15;
            }
        }

        // Convert units
        function convertUnits() {
            const fromInput = document.getElementById('fromInput');
            const toInput = document.getElementById('toInput');
            const fromUnit = document.getElementById('fromUnit').value;
            const toUnit = document.getElementById('toUnit').value;
            const formulaDiv = document.getElementById('conversionFormula');
            const errorDiv = document.getElementById('errorMessage');

            // Clear previous messages
            formulaDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');

            const inputValue = parseFloat(fromInput.value);
            
            if (isNaN(inputValue) || fromInput.value === '') {
                toInput.value = '';
                return;
            }

            try {
                let result;
                let formula = '';

                if (currentCategory === 'temperature') {
                    result = convertTemperature(inputValue, fromUnit, toUnit);
                    formula = getTemperatureFormula(inputValue, fromUnit, toUnit);
                } else {
                    const categoryData = unitCategories[currentCategory];
                    const fromFactor = categoryData.units[fromUnit].factor;
                    const toFactor = categoryData.units[toUnit].factor;
                    
                    result = (inputValue * fromFactor) / toFactor;
                    
                    const fromSymbol = categoryData.units[fromUnit].symbol;
                    const toSymbol = categoryData.units[toUnit].symbol;
                    
                    let factorRatio = fromFactor / toFactor;
                    let formulaDisplay = factorRatio.toFixed(6).replace(/\.?0+$/, ''); // Clean up trailing zeros

                    formula = `${inputValue} ${fromSymbol} × ${formulaDisplay} = ${formatResult(result)} ${toSymbol}`;
                }

                toInput.value = formatResult(result);
                
                // Show formula
                formulaDiv.textContent = formula;
                formulaDiv.classList.remove('hidden');

            } catch (error) {
                errorDiv.textContent = 'Conversion error: ' + error.message;
                errorDiv.classList.remove('hidden');
                toInput.value = '';
            }
        }

        // Get temperature conversion formula
        function getTemperatureFormula(value, fromUnit, toUnit) {
            const conversion = `${fromUnit} → ${toUnit}`;
            
            switch (conversion) {
                case 'celsius → fahrenheit':
                    return `${value}°C × 9/5 + 32 = ${(value * 9/5 + 32).toFixed(2)}°F`;
                case 'fahrenheit → celsius':
                    return `(${value}°F - 32) × 5/9 = ${((value - 32) * 5/9).toFixed(2)}°C`;
                case 'celsius → kelvin':
                    return `${value}°C + 273.15 = ${(value + 273.15).toFixed(2)}K`;
                case 'kelvin → celsius':
                    return `${value}K - 273.15 = ${(value - 273.15).toFixed(2)}°C`;
                case 'fahrenheit → kelvin':
                    const celsiusFtoK = (value - 32) * 5/9;
                    return `(${value}°F - 32) × 5/9 + 273.15 = ${(celsiusFtoK + 273.15).toFixed(2)}K`;
                case 'kelvin → fahrenheit':
                    const fahrenheitKtoF = (value - 273.15) * 9/5 + 32;
                    return `(${value}K - 273.15) × 9/5 + 32 = ${fahrenheitKtoF.toFixed(2)}°F`;
                default:
                    return `${value} ${fromUnit} = ${value} ${toUnit}`;
            }
        }

        // Format result for display
        function formatResult(value) {
            if (Math.abs(value) >= 1e6 || (Math.abs(value) < 0.001 && value !== 0)) {
                return value.toExponential(6);
            } else if (Math.abs(value) >= 100) {
                return value.toFixed(2);
            } else {
                return value.toFixed(6).replace(/\.?0+$/, '');
            }
        }

        // Swap units
        function swapUnits() {
            const fromSelect = document.getElementById('fromUnit');
            const toSelect = document.getElementById('toUnit');
            const fromInput = document.getElementById('fromInput');
            const toInput = document.getElementById('toInput');
            
            // Custom display elements
            const fromDisplay = document.getElementById('fromUnitDisplay').querySelector('.custom-select-text');
            const toDisplay = document.getElementById('toUnitDisplay').querySelector('.custom-select-text');

            // 1. Swap selections (native and custom display)
            const tempValue = fromSelect.value;
            fromSelect.value = toSelect.value;
            toSelect.value = tempValue;
            
            const tempDisplayText = fromDisplay.textContent;
            fromDisplay.textContent = toDisplay.textContent;
            toDisplay.textContent = tempDisplayText;

            // 2. Swap input values
            const tempInputValue = fromInput.value;
            fromInput.value = toInput.value;
            toInput.value = '';

            // Reconvert
            if (fromInput.value) {
                convertUnits();
            }
        }

        // Clear inputs
        function clearInputs() {
            document.getElementById('fromInput').value = '';
            document.getElementById('toInput').value = '';
            document.getElementById('conversionFormula').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // Initialize when page loads
        window.addEventListener('load', () => {
            initConverter();
        });
    </script>
</body>
</html>
